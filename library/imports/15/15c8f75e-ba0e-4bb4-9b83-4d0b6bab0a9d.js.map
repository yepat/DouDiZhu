{"version":3,"sources":["../../../../../assets/Script/gameNetwork/assets/Script/gameNetwork/GameNet.js"],"names":["ByteArray","require","config","EventHelper","Protocol","Events","GameNet","cc","Class","extends","Component","statics","ip","sio","isPinging","fnDisconnect","handlers","addHandler","event","fn","connect","port","callback","self","WebSocket","binaryType","onopen","evt","console","log","onmessage","cmd","strdata","data","JSON","parse","receivedMsg","onclose","onerror","send","params","view","getView","close","code","Command","HeartBeat","Response","Alive","DispatchCustomEvent","MyNode","Login","Regist","OK","Game","NoLogin","handleLoginRoomResult","InitOk","CoinsNoMatchRoom","response","succ","coinsNoMatchRoom","inGaming","msg","newRoomId","CompatibleHelper","RoomId","name","Network","LoginRoomResult","ok","payload","noCoin"],"mappings":"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","file":"GameNet.js","sourceRoot":"../../../../../assets/Script/gameNetwork","sourcesContent":["\n\nvar ByteArray = require(\"ByteArray\");\nvar config = require(\"config\");\nvar EventHelper = require(\"EventHelper\");\nvar Protocol = require(\"Protocol\");\nvar Events = require(\"Events\");\n\nvar GameNet = cc.Class({\n    extends: cc.Component,\n    statics: {\n        ip:\"\",\n        sio:null,\n        isPinging:false,\n        fnDisconnect:null,\n        handlers:{},\n        addHandler:function(event,fn){\n            \n        },\n        connect:function(ip,port,callback){\n            var self = this;\n            self.callback = callback;\n            this.ip = ip + \":\" + port;\n            this.sio = new WebSocket(\"ws://\"+this.ip);\n            this.sio.binaryType = \"arraybuffer\";\n            this.sio.onopen = function(evt) { \n                console.log(\"Connection open \");\n                self.isPinging = true\n                self.callback();\n            };\n            this.sio.onmessage = function(evt) {\n                // console.log(evt.data);\n                // console.log(\"length:\"+evt.data.length)\n                var cmd = -1;//第八位是大协议号\n                var strdata = evt.data;\n                var data = JSON.parse(strdata);\n                self.receivedMsg(data,cmd);\n            };\n            this.sio.onclose = function(evt) {\n                console.log(\"Connection closed.\");\n                self.isPinging = false;\n            }; \n            this.sio.onerror = function(evt) {\n                console.log(\"Connection onerror.\"+ evt.data);\n                self.isPinging = false;\n            }; \n        },\n        send:function(event,cmd,params){\n            console.log(\"send:\"+event);\n            var view = ByteArray.getView(params,cmd);\n            if(this.sio)\n                this.sio.send(view);\n        },\n        close:function(){\n            if(this.sio)\n                this.sio.close();\n        },\n        receivedMsg(data,cmd){\n            // console.log(typeof(data));\n            // console.log(data);\n            cmd = data.cmd;\n            console.log(\"cmd:\"+cmd+\" code:\"+data.code);\n\n            if(cmd == Protocol.Command.HeartBeat){ //心跳\n                if(data.code == Protocol.Response.HeartBeat.Alive){\n                    EventHelper.DispatchCustomEvent(config.MyNode,\"HeartBeat\",data);\n                }\n            }\n\n            if(cmd == Protocol.Command.Login){//登陆\n                if(data.code == Protocol.Response.Login.Regist){\n                    EventHelper.DispatchCustomEvent(config.MyNode,\"Regist\",data);\n                }else if(data.code == Protocol.Response.Login.OK){\n                    EventHelper.DispatchCustomEvent(config.MyNode,\"LoginOK\",data);\n                }\n            }\n\n            if(cmd == Protocol.Command.Game){\n                console.log(data);\n                if(data.code == Protocol.Response.Game.NoLogin){\n                    this.handleLoginRoomResult(data,data.code);\n                }else if(data.code == Protocol.Response.Game.InitOk){\n                    this.handleLoginRoomResult(data,data.code);\n                }else if(data.code == Protocol.Response.Game.CoinsNoMatchRoom){\n                    this.handleLoginRoomResult(data,data.code);\n                }\n            }\n\n        },\n        handleLoginRoomResult(response, code){\n            var succ = true;\n            var coinsNoMatchRoom = false;\n            var inGaming = false;\n            var msg = null;\n            var newRoomId = null;\n\n            if (code == Protocol.Response.Game.NoLogin){\n                succ = false;\n                console.log(\"未登录\");\n                return;\n            }else if (code == Protocol.Response.Game.InitOk){\n                console.log(\"进入房间成功\");\n                if (response[\"data\"][\"isGaming\"] == 1){\n                    console.log(\"进入未完成牌局\");\n                    inGaming = true;\n                    succ = false;\n                    CompatibleHelper.RoomId = response[\"data\"][\"roomId\"];\n                }\n            }else if (code == Protocol.Response.Game.CoinsNoMatchRoom){\n                console.log(\"进入房间失败\");\n                succ = false;\n                coinsNoMatchRoom = true;\n                msg = response[\"data\"][\"msg\"];\n                newRoomId = response[\"data\"][\"newRoomId\"];\n            }\n\n            var params = {};\n            params.name = Events.Network.LoginRoomResult;\n            params.ok = succ;\n            params.payload = response;\n            params.noCoin = coinsNoMatchRoom;\n            params.inGaming = inGaming;\n            params.msg = msg;\n            params.newRoomId = newRoomId;\n\n            EventHelper.DispatchCustomEvent(config.MyNode,Events.Network.LoginRoomResult,params);\n        }\n    },\n});"]}